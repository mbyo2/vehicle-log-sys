# Email Verification Implementation Guide

## Overview

This application includes a complete email verification system for user signup. Users must verify their email address to access all features.

## Features Implemented

### 1. Email Verification Flow
- **Automatic email sending** on user signup
- **Verification email template** with branded HTML
- **Resend verification** functionality for users
- **Email verification banner** displayed to unverified users

### 2. Components

#### EmailVerificationBanner
- Location: `src/components/auth/EmailVerificationBanner.tsx`
- Displays at top of authenticated pages for unverified users
- Shows user's email address
- Provides "Resend" button with loading state
- Dismissible with X button
- Success state after resending

#### Verification Email Template
- Location: `supabase/functions/send-email/_templates/verification-email.tsx`
- React Email component for consistent branding
- Click-to-verify button
- Copy/paste verification link fallback
- 24-hour expiration notice

### 3. Technical Implementation

#### Signup Flow
The signup process automatically:
1. Creates user account with Supabase Auth
2. Sends verification email via `send-email` edge function
3. Redirects to sign-in page with success message
4. Email failures are logged but don't block signup

#### Email Sending
```typescript
await supabase.functions.invoke('send-email', {
  body: {
    type: 'verification',
    email: userEmail,
    data: {
      confirmationUrl: `${window.location.origin}/`,
      userEmail: userEmail
    }
  }
});
```

#### Verification Check
The app checks `user.email_confirmed_at` to determine verification status:
- `null` = unverified (banner shown)
- `timestamp` = verified (banner hidden)

## Configuration Requirements

### 1. Resend API Key ✅
- Already configured in Supabase secrets
- Secret name: `RESEND_API_KEY`
- Used by: `send-email` edge function

### 2. Supabase URL Configuration
**CRITICAL:** You must configure the Site URL and Redirect URLs in Supabase Dashboard:

1. Go to [Supabase Authentication Settings](https://supabase.com/dashboard/project/yyeypbfdtitxqssvnagy/auth/url-configuration)

2. Set **Site URL** to:
   - Development: `http://localhost:3000`
   - Production: Your deployed URL (e.g., `https://yourapp.com`)

3. Add **Redirect URLs**:
   - Development: `http://localhost:3000/**`
   - Lovable preview: `https://lovable.dev/projects/c29f3e89-e43a-4ff1-8b01-1c1e6b7b5b61/**`
   - Production: `https://yourapp.com/**`
   - Supabase: `https://yyeypbfdtitxqssvnagy.supabase.co/**`

### 3. Email Sender Configuration

#### Resend Setup
1. Go to [Resend Dashboard](https://resend.com/domains)
2. **Verify your sending domain** (critical!)
3. Update the `from` email in `send-email/index.ts`:
   ```typescript
   from: 'Fleet Manager <noreply@yourdomain.com>'
   ```

## Testing

### Test Email Verification Flow

1. **Sign up a new user:**
   ```
   Navigate to /signup
   Fill in: email, password, full name
   Click "Create Account"
   ```

2. **Check inbox:**
   - Look for verification email
   - Subject: "Verify your email address"
   - Click "Verify Email Address" button

3. **After clicking link:**
   - User should be redirected to your app
   - Sign in with credentials
   - Banner should NOT appear (email verified)

4. **Test unverified state:**
   - Sign up new user
   - Don't click verification link
   - Sign in anyway (email confirmation not required for login)
   - Banner should appear at top of page

5. **Test resend:**
   - Click "Resend" in banner
   - Check inbox for new email
   - Click link to verify

### Common Issues

#### Email not sending
- ✅ Check RESEND_API_KEY is set in Supabase secrets
- ✅ Verify domain in Resend dashboard
- ✅ Check edge function logs for errors
- ✅ Ensure "from" email uses verified domain

#### Redirect errors
- ✅ Verify Site URL matches your deployment URL
- ✅ Add all redirect URLs with `/**` wildcard
- ✅ Check browser console for CORS errors

#### Banner not showing
- ✅ User must be authenticated
- ✅ Check `user.email_confirmed_at` is null
- ✅ Banner can be dismissed (check state)
- ✅ Refresh page after dismissing

## Security Considerations

### Email Verification Tokens
- Generated by Supabase Auth automatically
- Valid for 24 hours by default
- One-time use only
- Secure token hash in URL

### Rate Limiting
- Resend has built-in rate limiting
- Consider adding custom rate limiting for resend button
- Implemented in signup flow (3 attempts per hour)

### Privacy
- Email addresses are not logged in plain text
- Verification emails contain no sensitive data
- Links expire after 24 hours

## Optional Enhancements

### Require Email Verification
To force users to verify before accessing the app:

1. Update Row Level Security policies to check `email_confirmed_at`
2. Add middleware to redirect unverified users
3. Block API access for unverified accounts

### Custom Verification Page
Create a dedicated `/verify-email` page:
- Shows verification status
- Provides resend button
- Better UX than banner

### Verification Reminders
Send reminder emails to unverified users:
- After 24 hours
- After 7 days
- Edge function with cron job

## Maintenance

### Edge Function Updates
Location: `supabase/functions/send-email/index.ts`
- Automatically deployed with code changes
- Check logs: [Edge Function Logs](https://supabase.com/dashboard/project/yyeypbfdtitxqssvnagy/functions/send-email/logs)

### Email Template Updates
Location: `supabase/functions/send-email/_templates/verification-email.tsx`
- React Email components
- Inline styles for email client compatibility
- Test across email clients before deploying

### Monitoring
- Monitor email delivery rates in Resend dashboard
- Check edge function invocation counts
- Track verification completion rate in analytics

## Related Documentation
- [Password Reset Flow](./PASSWORD_RESET_FLOW.md)
- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Resend Documentation](https://resend.com/docs)
- [React Email Documentation](https://react.email/)
